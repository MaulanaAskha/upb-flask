{% extends 'master/base.html' %}

{% set title = "Embung" %}

{% block css %}
<link rel="stylesheet" href="//cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css">
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="font-weight-lighter">Embung <small class="font-weight-lighter text-muted">({{ ctx.hulu.all_embung|length + ctx.madiun.all_embung|length + ctx.hilir.all_embung|length }})</small></h1>
    <div class="row">
      <div class="col">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Hulu <small class="text-weight-lighter">({{ ctx.hulu.all_embung|length }})</small></h5>
            <div class="row">
              <div class="col-sm-4"><small class="float-left text-secondary">Vol {{ ctx.hulu.all_embung|length }} embung</small></div>
              <div class="col-sm-6"><h1 class="float-right text-monospace">{{ "{:0,.0f}".format(ctx.hulu.vol).replace(',', '.') }}</h1></div>
              <div class="col-sm-2">M <sup>3</sup></div>
            </div>
            <div class="row">
              <div class="col-sm-4"><small class="float-left text-secondary">Tampungan </small></div>
              <div class="col-sm-6"><h1 class="float-right text-monospace">{{ "{:0,.0f}".format(ctx.hulu.tampungan).replace(',', '.') }}</h1></div>
              <div class="col-sm-2">M <sup>3</sup></div>
            </div>
            <a href="#table_hulu" data-toggle="collapse" class="card-link">Daftar Embung</a>
          </div>
        </div>

        <table class="table collapse" id="table_hulu">
          <thead>
            <tr>
              <th></th>
              <th><small class="font-weight-lighter">Nama, Kab</small></th>
              <th><small class="font-weight-lighter">Vol M<sup>3</sup></small></th>
            </tr>
          </thead>
          <tbody>
          {% for e in ctx.hulu.all_embung %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ e.nama.replace('Embung ', '') }} {% if e.kab %}<small class="text-secondary">{{ e.kab[:4] }}</small>{% endif %}</td>
            <td class="text-monospace text-right">{% if e.vol %}<small>{{ "{:0,.0f}".format(e.vol) }}</small>{% endif %}</td>
          </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="col">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Madiun  <small class="text-weight-lighter">({{ ctx.madiun.all_embung|length }})</small></h5>
            <div class="row">
              <div class="col-sm-4"><small class="float-left text-secondary">Vol {{ ctx.madiun.all_embung|length }} embung</small></div>
              <div class="col-sm-6"><h1 class="float-right text-monospace">{{ "{:0,.0f}".format(ctx.madiun.vol).replace(',', '.') }}</h1></div>
              <div class="col-sm-2">M <sup>3</sup></div>
            </div>
            <div class="row">
              <div class="col-sm-4"><small class="float-left text-secondary">Tampungan </small></div>
              <div class="col-sm-6"><h1 class="float-right text-monospace">{{ "{:0,.0f}".format(ctx.madiun.tampungan).replace(',', '.') }}</h1></div>
              <div class="col-sm-2">M <sup>3</sup></div>
            </div>
            <a href="#table_madiun" data-toggle="collapse" class="card-link">Daftar Embung</a>
          </div>
        </div>
        
        <table class="table collapse" id="table_madiun">
          <thead>
            <tr>
              <th></th>
              <th><small class="font-weight-lighter">Nama, Kab</small></th>
              <th><small class="font-weight-lighter">Vol M<sup>3</sup></small></th>
            </tr>
          </thead>
          <tbody>
          {% for e in ctx.madiun.all_embung %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ e.nama.replace('Embung ', '') }} {% if e.kab %}<small class="text-secondary">{{ e.kab[:4] }}</small>{% endif %}</td>
            <td class="text-monospace text-right">{% if e.vol %}{{ e.vol }}{% endif %}</td>
          </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="col">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Hilir <small class="text-weight-lighter">({{ ctx.hilir.all_embung|length }})</small></h5>
            <div class="row">
              <div class="col-sm-4"><small class="float-left text-secondary">Vol {{ ctx.hilir.all_embung|length }} embung</small></div>
              <div class="col-sm-6"><h1 class="float-right text-monospace">{{ "{:0,.0f}".format(ctx.hilir.vol).replace(',', '.') }}</h1></div>
              <div class="col-sm-2">M <sup>3</sup></div>
            </div>
            <div class="row">
              <div class="col-sm-4"><small class="float-left text-secondary">Tampungan </small></div>
              <div class="col-sm-6"><h1 class="float-right text-monospace">{{ "{:0,.0f}".format(ctx.hilir.tampungan).replace(',', '.') }}</h1></div>
              <div class="col-sm-2">M <sup>3</sup></div>
            </div>
            <a href="#table_hilir" data-toggle="collapse" class="card-link">Daftar Embung</a>
          </div>
        </div>

        <table class="table collapse" id="table_hilir">
          <thead>
            <tr>
              <th></th>
              <th><small class="font-weight-lighter">Nama, Kab</small></th>
              <th><small class="font-weight-lighter">Vol M<sup>3</sup></small></th>
            </tr>
          </thead>
          <tbody>
          {% for e in ctx.hilir.all_embung %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ e.nama.replace('Embung ', '') }} {% if e.kab %}<small class="text-secondary">{{ e.kab[:4] }}</small>{% endif %}</td>
            <td class="text-monospace text-right">{% if e.vol %}<small>{{ "{:0,.0f}".format(e.vol) }}</small>{% endif %}</td>
          </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script src="//cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
<script>
    jQuery.fn.dataTable.Api.register( 'sum()', function ( ) {
            return this.flatten().reduce( function ( a, b ) {
                    if ( typeof a === 'string' ) {
                            a = a.replace(/[^\d.-]/g, '') * 1;
                    }
                    if ( typeof b === 'string' ) {
                            b = b.replace(/[^\d.-]/g, '') * 1;
                    }

            return a + b;
            }, 0 );
    } );
    function updateLen(id, val) {
        document.getElementById(id).innerHTML = val;
    }
    $(document).ready(function() {
            let eb_len = {{ embung_b|length }};
            let ea_len = {{ embung_a|length }};
            updateLen("ea_len", ea_len);
            updateLen("eb_len", eb_len);
            var numberFormat = function (obj) {
                    return parseInt(obj).toLocaleString('id-ID');
            };
            var dt_bpa = $('#bpa').DataTable({
                    "order": [[3, 'desc']],
                    "paging": false,
                    "dom": '<"summary">f',
                    "language": {
                            "decimal": ",",
                            "thousands": "."
                    }
            });
            $('div.summary').html('Banyak: <b id="s_banyak" class="s_item">102</b>, Tampungan: <b class="s_item"><span id="s_tampungan">-</span> M<sup>3</sup>, </b>Irigasi: <b class="s_item"><span id="s_irigasi"></span> Ha</b>');
            var dt_ab = $('#ab').DataTable({
                    "order": [[3, 'desc']],
                    "dom": '<"summary_ab">f',
                    "paging": false,
                    "language": {
                            "decimal": ",",
                            "thousands": "."
                    }
            });
            $('div.summary_ab').html('Banyak: <b id="s_banyak_ab" class="s_item">72</b> Tampungan: <b class="s_item"><span  id="s_tampungan_ab">-</span> M<sup>3</sup></b>Air Baku: <b class="s_item"><span id="s_airbaku"></span> KK</b>');
            dt_bpa.on('draw', function () {
                    var tampungan = dt_bpa.column(3, {filter: 'applied'}).data().sum();
                    $('#s_tampungan').text(numberFormat(tampungan));
                    $('#s_banyak').text(dt_bpa.rows({filter: 'applied'}).data().length)
                    $('#s_irigasi').text(numberFormat(dt_bpa.column(4, {filter: 'applied'}).data().sum()));
                    updateLen("eb_len", dt_bpa.rows({filter: 'applied'}).data().length);
            });
            dt_ab.on('draw', function () {
                    $('#s_banyak_ab').text(dt_ab.rows({filter: 'applied'}).data().length)
                    $('#s_tampungan_ab').text(numberFormat(dt_ab.column(3, {filter: 'applied'}).data().sum()));
                    $('#s_airbaku').text(numberFormat(dt_ab.column(4, {filter: 'applied'}).data().sum()));
                    updateLen("ea_len", dt_ab.rows({filter: 'applied'}).data().length);
            });
            $('#s_tampungan').text(dt_bpa.column(3, {filter: 'applied'}).data().sum());
            $('#s_irigasi').text(numberFormat(dt_bpa.column(4, {filter: 'applied'}).data().sum()));
            $('#s_tampungan').text(numberFormat($('#s_tampungan').text()));
            $('#s_tampungan_ab').text(numberFormat(dt_ab.column(3, {filter: 'applied'}).data().sum()));
            $('#s_airbaku').text(numberFormat(dt_ab.column(4, {filter: 'applied'}).data().sum()));
    });
  </script>

{% endblock %}
